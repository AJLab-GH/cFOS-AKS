---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fos
  namespace: fos
  labels:
    app: fos
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fos
  template:
    metadata:
      annotations:
        container.apparmor.security.beta.kubernetes.io/fos: unconfined
      labels:
        app: fos
        api: allow
    spec:
      nodeSelector:
        "kubernetes.io/os": linux
      containers:
        - name: fos
          image: ghcr.io/robinmordasiewicz/fos:latest
          ports:
            - containerPort: 80
              name: fos
            - name: isakmp
              containerPort: 500
              protocol: UDP
            - name: ipsec-nat-t
              containerPort: 4500
              protocol: UDP
          volumeMounts:
            - mountPath: /data
              name: data-volume
          env:
            - name: fos-license
              valueFrom:
                configMapKeyRef:
                  name: fos-license
                  key: license
          securityContext:
            allowPrivilegeEscalation: true
            capabilities:
              add: ["NET_ADMIN", "SYS_ADMIN", "NET_RAW"]
          resources:
            requests:
              cpu: 4m
              memory: 2Gi
            limits:
              cpu: 8000m
              memory: 4096Mi
        - name: myapp
          image: alpine:latest
          command: ['sh', '-c', 'echo "logging" > /opt/logs.txt']
          volumeMounts:
            - name: data
              mountPath: /opt
      volumes:
        - name: data-volume
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: fos
  namespace: fos
spec:
  ports:
    - port: 8001
      targetPort: 8001
  selector:
    app: fos
  type: ClusterIP
